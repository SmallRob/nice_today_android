# 功能图标拖拽排序功能使用说明

## 功能概述

用户可以通过拖拽方式自定义功能卡片的排序，系统会自动保存用户的排序偏好，确保下次打开时按用户的设置显示。

## 主要功能

### 1. 编辑模式
- 点击 "✏️ 编辑排序" 按钮进入编辑模式
- 编辑模式下，功能卡片右上角会显示拖拽手柄 (⋮⋮)
- 拖拽功能卡片可以重新排序
- 点击 "✓ 完成排序" 保存并退出编辑模式

### 2. 拖拽排序
- 在编辑模式下，按住功能卡片可以拖动到新位置
- 支持桌面端鼠标拖拽和移动端触摸拖拽
- 拖拽过程中有视觉反馈（透明度变化、阴影效果）
- 放置时自动更新排序

### 3. 配置保存
- 排序配置自动保存到 localStorage
- 存储键名：`feature_cards_sort_order`
- 配置格式：功能ID数组
- 例如：`['todo', 'finance', 'takashima', ...]`

### 4. 配置加载
- 页面加载时自动读取保存的排序配置
- 如果没有保存的配置，使用默认排序
- 支持容错处理，配置错误时自动回退到默认排序

### 5. 新增功能处理
- 新增的功能卡片会自动添加到用户自定义排序的后面
- 不会影响用户的现有排序
- 确保用户不会丢失自定义配置

### 6. 重置功能
- 点击 "↺ 重置默认" 按钮可以恢复默认排序
- 会清除 localStorage 中的配置
- 需要用户确认才能执行

## 技术实现

### 文件结构

```
frontend/
├── src/
│   ├── pages/
│   │   └── DashboardPage.js          # 主页面，管理拖拽逻辑
│   ├── components/
│   │   └── dashboard/
│   │       ├── FeatureCard.js        # 功能卡片组件，支持拖拽
│   │       └── FeatureCards.js       # 所有功能卡片定义
│   ├── utils/
│   │   └── featureSortConfig.js     # 排序配置管理工具
│   └── styles/
│       └── dashboard.css             # 样式文件，包含拖拽样式
```

### 核心组件

#### 1. featureSortConfig.js - 配置管理工具

提供以下功能：
- `loadFeatureSortOrder()` - 加载排序配置
- `saveFeatureSortOrder(order)` - 保存排序配置
- `mergeFeatureOrder(savedOrder, currentFeatures)` - 合并默认和自定义排序
- `resetFeatureSortOrder()` - 重置为默认排序
- `getFeatureId(componentName)` - 获取功能ID

#### 2. DashboardPage.js - 主页面

主要功能：
- 管理功能卡片列表状态
- 处理拖拽排序逻辑
- 保存和加载排序配置
- 提供编辑模式切换

#### 3. FeatureCard.js - 功能卡片

新增属性：
- `draggable` - 是否可拖拽
- `onDragStart` - 拖拽开始回调
- `onDragEnd` - 拖拽结束回调
- `index` - 卡片索引
- `id` - 功能ID

### 拖拽实现

使用 HTML5 Drag and Drop API：
- `draggable` 属性控制是否可拖拽
- `onDragStart` 事件开始拖拽
- `onDragOver` 事件允许放置
- `onDrop` 事件处理放置
- `onDragEnd` 事件结束拖拽

### 样式

新增 CSS 类：
- `.feature-card-draggable` - 可拖拽卡片样式
- `.feature-card-dragging` - 拖拽中样式
- `.drag-handle` - 拖拽手柄
- `.edit-mode-btn` - 编辑模式按钮
- `.reset-order-btn` - 重置按钮

### 默认排序

功能按以下分类默认排序：
1. 日常管理类（待办事项、财务斩杀线）
2. 运势分析类（高岛易断、生肖运势、星座运势、八字月运、紫微命宫）
3. 个人成长类（MBTI测试、星座特质、能量提升、生命矩阵）
4. 健康管理类（人体节律、经期助手）

### 容错机制

1. **配置加载失败**
   - 捕获异常并记录错误
   - 自动回退到默认排序
   - 不会影响页面正常显示

2. **配置格式错误**
   - 验证配置是否为数组
   - 验证每个ID是否为字符串
   - 无效配置自动使用默认排序

3. **功能缺失**
   - 过滤掉不存在的功能ID
   - 只显示当前可用的功能
   - 新增功能自动追加

4. **LocalStorage 不可用**
   - 检测 localStorage 是否可用
   - 不可用时不保存配置
   - 使用内存状态，不影响使用

## 使用流程

### 用户操作流程

1. 用户打开 Dashboard 页面
2. 系统自动加载保存的排序配置
3. 功能卡片按配置排序显示
4. 用户点击 "✏️ 编辑排序" 按钮
5. 进入编辑模式，显示拖拽手柄
6. 用户拖拽卡片到新位置
7. 实时更新排序和界面
8. 点击 "✓ 完成排序" 保存配置
9. 自动保存到 localStorage
10. 退出编辑模式

### 开发者添加新功能

1. 在 `FeatureCards.js` 中定义新的功能卡片组件
2. 在 `DashboardPage.js` 的 `allFeatures` 数组中添加新功能
3. 在 `featureSortConfig.js` 的 `DEFAULT_FEATURE_ORDER` 中添加默认ID
4. 更新 `getFeatureId` 函数映射（如果需要）
5. 新功能会自动出现在用户排序的后面

## 测试建议

### 功能测试
- [ ] 正常拖拽功能
- [ ] 保存排序后刷新页面
- [ ] 关闭浏览器后重新打开
- [ ] 编辑模式切换
- [ ] 重置默认排序
- [ ] 移动端触摸拖拽

### 容错测试
- [ ] 清除 localStorage 后访问
- [ ] 手动修改配置为无效格式
- [ ] 手动删除配置文件
- [ ] 在不支持 localStorage 的环境中

### 兼容性测试
- [ ] Chrome 桌面版
- [ ] Firefox 桌面版
- [ ] Safari 桌面版
- [ ] 移动端浏览器
- [ ] Android WebView
- [ ] iOS WebView

## 注意事项

1. **性能优化**
   - 拖拽操作使用节流/防抖
   - 避免频繁的 localStorage 写入
   - 使用 React 优化渲染

2. **用户体验**
   - 拖拽时提供清晰的视觉反馈
   - 支持撤销操作（可选）
   - 防止误触（需要确认）

3. **数据安全**
   - 配置仅保存在本地
   - 不上传到服务器
   - 可以随时重置

4. **可扩展性**
   - 支持动态添加新功能
   - 保持向后兼容
   - 配置格式可扩展

## 常见问题

### Q: 拖拽功能不工作？
A: 确保浏览器支持 HTML5 Drag and Drop API，且已进入编辑模式。

### Q: 排序没有保存？
A: 检查浏览器是否允许 localStorage，确保没有清除浏览器数据。

### Q: 如何恢复默认排序？
A: 在编辑模式下点击 "↺ 重置默认" 按钮即可。

### Q: 新功能为什么在最后？
A: 为了不影响用户的自定义排序，新功能会自动添加到用户排序的后面。

### Q: 配置丢失怎么办？
A: 可以点击 "重置默认" 按钮恢复到初始排序，或者清除浏览器缓存。

## 更新日志

### v1.0.0 (2025-12-28)
- 初始版本
- 实现基础拖拽排序功能
- 配置保存和加载
- 编辑模式切换
- 重置默认排序
- 新增功能自动追加
- 完整的容错机制
