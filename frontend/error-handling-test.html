<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é”™è¯¯å¤„ç†éªŒè¯æµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    h1 {
      color: #333;
      text-align: center;
    }

    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #fafafa;
    }

    .test-section h2 {
      margin-top: 0;
      color: #666;
      font-size: 18px;
    }

    .test-button {
      background: #2196F3;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .test-button:hover {
      background: #1976D2;
    }

    .test-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .test-button.success {
      background: #4CAF50;
    }

    .test-button.error {
      background: #f44336;
    }

    .result-box {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }

    .result-box.success {
      background: #E8F5E9;
      border: 1px solid #4CAF50;
      color: #2E7D32;
    }

    .result-box.error {
      background: #FFEBEE;
      border: 1px solid #f44336;
      color: #C62828;
    }

    .result-box.info {
      background: #E3F2FD;
      border: 1px solid #2196F3;
      color: #1565C0;
    }

    .device-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }

    .info-item {
      padding: 10px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
    }

    .info-label {
      font-weight: bold;
      color: #666;
      font-size: 12px;
    }

    .info-value {
      color: #333;
      font-size: 14px;
    }

    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }

    .status-indicator.pass {
      background: #4CAF50;
    }

    .status-indicator.fail {
      background: #f44336;
    }

    .status-indicator.pending {
      background: #FF9800;
    }
  </style>
</head>
<body>
  <h1>ğŸ” é”™è¯¯å¤„ç†éªŒè¯æµ‹è¯•</h1>

  <div class="container">
    <div class="test-section">
      <h2>ğŸ“± è®¾å¤‡ä¿¡æ¯</h2>
      <div id="deviceInfo" class="device-info"></div>
    </div>

    <div class="test-section">
      <h2>ğŸ§ª é”™è¯¯å¤„ç†æµ‹è¯•</h2>
      <button class="test-button" onclick="testBasicError()">æµ‹è¯•åŸºæœ¬é”™è¯¯å¤„ç†</button>
      <button class="test-button" onclick="testErrorLocation()">æµ‹è¯•é”™è¯¯ä½ç½®è§£æ</button>
      <button class="test-button" onclick="testStackTrace()">æµ‹è¯•å †æ ˆåˆ†æ</button>
      <button class="test-button" onclick="testPromiseError()">æµ‹è¯• Promise é”™è¯¯</button>
      <button class="test-button" onclick="testGlobalError()">æµ‹è¯•å…¨å±€é”™è¯¯æ•è·</button>
      <div id="testResults"></div>
    </div>

    <div class="test-section">
      <h2>ğŸ“Š é”™è¯¯æŠ¥å‘Šç”Ÿæˆ</h2>
      <button class="test-button" onclick="generateErrorReport()">ç”Ÿæˆé”™è¯¯æŠ¥å‘Š</button>
      <button class="test-button" onclick="exportErrorReport()">å¯¼å‡ºé”™è¯¯æŠ¥å‘Š</button>
      <div id="reportResults"></div>
    </div>

    <div class="test-section">
      <h2>ğŸ”§ ç§»åŠ¨è®¾å¤‡ç‰¹æ®Šæµ‹è¯•</h2>
      <button class="test-button" onclick="testMobileWebView()">æµ‹è¯• WebView æ£€æµ‹</button>
      <button class="test-button" onclick="testMobileErrorHandling()">æµ‹è¯•ç§»åŠ¨è®¾å¤‡é”™è¯¯å¤„ç†</button>
      <button class="test-button" onclick="testUserMessages()">æµ‹è¯•ç”¨æˆ·æ¶ˆæ¯ç”Ÿæˆ</button>
      <div id="mobileResults"></div>
    </div>

    <div class="test-section">
      <h2>ğŸš€ è¿è¡Œå®Œæ•´éªŒè¯</h2>
      <button class="test-button" onclick="runAllTests()" id="runAllButton">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
      <div id="allTestResults"></div>
    </div>
  </div>

  <script type="module">
    // åŠ¨æ€å¯¼å…¥é”™è¯¯å¤„ç†æ¨¡å—
    let globalErrorHandler, getErrorLocation, createDetailedErrorReport, getDeviceInfo, isMobileDevice, isAndroidWebView, isIOSWebView;

    try {
      const module = await import('./utils/errorHandler.js');
      globalErrorHandler = module.globalErrorHandler;
      getErrorLocation = module.getErrorLocation;
      createDetailedErrorReport = module.createDetailedErrorReport;
      getDeviceInfo = module.getDeviceInfo;
      isMobileDevice = module.isMobileDevice;
      isAndroidWebView = module.isAndroidWebView;
      isIOSWebView = module.isIOSWebView;
      console.log('âœ“ é”™è¯¯å¤„ç†æ¨¡å—åŠ è½½æˆåŠŸ');
    } catch (error) {
      console.error('âœ— é”™è¯¯å¤„ç†æ¨¡å—åŠ è½½å¤±è´¥:', error);
      alert('é”™è¯¯å¤„ç†æ¨¡å—åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿åœ¨æ­£ç¡®çš„ç¯å¢ƒä¸­è¿è¡Œæ­¤æµ‹è¯•é¡µé¢');
    }

    // æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
    if (getDeviceInfo) {
      const deviceInfo = getDeviceInfo();
      const deviceInfoHtml = `
        <div class="info-item">
          <div class="info-label">ç§»åŠ¨è®¾å¤‡</div>
          <div class="info-value">${deviceInfo.isMobile ? 'æ˜¯' : 'å¦'}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Android WebView</div>
          <div class="info-value">${deviceInfo.isAndroidWebView ? 'æ˜¯' : 'å¦'}</div>
        </div>
        <div class="info-item">
          <div class="info-label">iOS WebView</div>
          <div class="info-value">${deviceInfo.isIOSWebView ? 'æ˜¯' : 'å¦'}</div>
        </div>
        <div class="info-item">
          <div class="info-label">å¹³å°</div>
          <div class="info-value">${deviceInfo.platform || 'æœªçŸ¥'}</div>
        </div>
        <div class="info-item">
          <div class="info-label">è¯­è¨€</div>
          <div class="info-value">${deviceInfo.language || 'æœªçŸ¥'}</div>
        </div>
        <div class="info-item">
          <div class="info-label">å±å¹•å®½åº¦</div>
          <div class="info-value">${deviceInfo.screenWidth || 'æœªçŸ¥'}px</div>
        </div>
        <div class="info-item">
          <div class="info-label">å±å¹•é«˜åº¦</div>
          <div class="info-value">${deviceInfo.screenHeight || 'æœªçŸ¥'}px</div>
        </div>
        <div class="info-item">
          <div class="info-label">è®¾å¤‡åƒç´ æ¯”</div>
          <div class="info-value">${deviceInfo.devicePixelRatio || 'æœªçŸ¥'}</div>
        </div>
      `;
      document.getElementById('deviceInfo').innerHTML = deviceInfoHtml;
    }

    // æµ‹è¯•å‡½æ•°
    window.testBasicError = function() {
      try {
        throw new Error('æµ‹è¯•åŸºæœ¬é”™è¯¯å¤„ç†');
      } catch (error) {
        const appError = globalErrorHandler.handle(error);
        showResult('testResults', 'âœ“ åŸºæœ¬é”™è¯¯å¤„ç†æµ‹è¯•é€šè¿‡', 'success');
        showResult('testResults', JSON.stringify({
          type: appError.type,
          message: appError.message,
          severity: appError.severity
        }, null, 2), 'info');
      }
    };

    window.testErrorLocation = function() {
      try {
        throw new Error('æµ‹è¯•é”™è¯¯ä½ç½®è§£æ');
      } catch (error) {
        const location = getErrorLocation(error);
        showResult('testResults', 'âœ“ é”™è¯¯ä½ç½®è§£ææµ‹è¯•é€šè¿‡', 'success');
        showResult('testResults', JSON.stringify(location, null, 2), 'info');
      }
    };

    window.testStackTrace = function() {
      try {
        throw new Error('æµ‹è¯•å †æ ˆåˆ†æ');
      } catch (error) {
        const location = getErrorLocation(error);
        const appError = globalErrorHandler.handle(error);
        showResult('testResults', 'âœ“ å †æ ˆåˆ†ææµ‹è¯•é€šè¿‡', 'success');
        showResult('testResults', {
          hasStack: !!error.stack,
          locationString: appError.getLocationString(),
          fileName: location.fileName,
          lineNumber: location.lineNumber
        }, 'info');
      }
    };

    window.testPromiseError = function() {
      Promise.reject(new Error('æµ‹è¯• Promise é”™è¯¯'))
        .catch(error => {
          const appError = globalErrorHandler.handle(error);
          showResult('testResults', 'âœ“ Promise é”™è¯¯æµ‹è¯•é€šè¿‡', 'success');
          showResult('testResults', JSON.stringify({
            type: appError.type,
            message: appError.message
          }, null, 2), 'info');
        });
    };

    window.testGlobalError = function() {
      const originalHandler = window.onerror;
      window.onerror = function(message, filename, lineno, colno, error) {
        showResult('testResults', 'âœ“ å…¨å±€é”™è¯¯æ•è·æµ‹è¯•é€šè¿‡', 'success');
        showResult('testResults', {
          message,
          filename,
          lineno,
          colno
        }, 'info');
        window.onerror = originalHandler;
        return true;
      };

      setTimeout(() => {
        throw new Error('æµ‹è¯•å…¨å±€é”™è¯¯æ•è·');
      }, 100);
    };

    window.generateErrorReport = function() {
      try {
        throw new Error('æµ‹è¯•é”™è¯¯æŠ¥å‘Šç”Ÿæˆ');
      } catch (error) {
        const appError = globalErrorHandler.handle(error);
        const report = createDetailedErrorReport(appError);
        showResult('reportResults', 'âœ“ é”™è¯¯æŠ¥å‘Šç”Ÿæˆæµ‹è¯•é€šè¿‡', 'success');
        showResult('reportResults', JSON.stringify(report, null, 2), 'info');
      }
    };

    window.exportErrorReport = function() {
      try {
        throw new Error('æµ‹è¯•é”™è¯¯æŠ¥å‘Šå¯¼å‡º');
      } catch (error) {
        const appError = globalErrorHandler.handle(error);
        const report = createDetailedErrorReport(appError);
        const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `error-report-${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        
        // ç¡®ä¿å…ƒç´ å­˜åœ¨åå†ç§»é™¤
        if (a.parentNode) {
          document.body.removeChild(a);
        }
        URL.revokeObjectURL(url);
        showResult('reportResults', 'âœ“ é”™è¯¯æŠ¥å‘Šå¯¼å‡ºæˆåŠŸ', 'success');
      }
    };

    window.testMobileWebView = function() {
      const isMobile = isMobileDevice();
      const isAndroid = isAndroidWebView();
      const isIOS = isIOSWebView();

      showResult('mobileResults', 'âœ“ WebView æ£€æµ‹æµ‹è¯•é€šè¿‡', 'success');
      showResult('mobileResults', JSON.stringify({
        isMobile,
        isAndroidWebView: isAndroid,
        isIOSWebView: isIOS
      }, null, 2), 'info');
    };

    window.testMobileErrorHandling = function() {
      try {
        throw new Error('æµ‹è¯•ç§»åŠ¨è®¾å¤‡é”™è¯¯å¤„ç†');
      } catch (error) {
        const appError = globalErrorHandler.handle(error);
        const deviceInfo = appError.deviceInfo;

        showResult('mobileResults', 'âœ“ ç§»åŠ¨è®¾å¤‡é”™è¯¯å¤„ç†æµ‹è¯•é€šè¿‡', 'success');
        showResult('mobileResults', JSON.stringify({
          hasDeviceInfo: !!deviceInfo,
          isMobile: deviceInfo.isMobile,
          errorType: appError.type,
          severity: appError.severity
        }, null, 2), 'info');
      }
    };

    window.testUserMessages = function() {
      try {
        throw new Error('æµ‹è¯•ç”¨æˆ·æ¶ˆæ¯ç”Ÿæˆ');
      } catch (error) {
        const appError = globalErrorHandler.handle(error);
        const userMessage = appError.getUserMessage();

        showResult('mobileResults', 'âœ“ ç”¨æˆ·æ¶ˆæ¯ç”Ÿæˆæµ‹è¯•é€šè¿‡', 'success');
        showResult('mobileResults', JSON.stringify({
          originalMessage: appError.message,
          userMessage: userMessage,
          messageType: typeof userMessage
        }, null, 2), 'info');
      }
    };

    window.runAllTests = function() {
      const button = document.getElementById('runAllButton');
      button.disabled = true;
      button.textContent = 'æµ‹è¯•è¿è¡Œä¸­...';

      const resultsDiv = document.getElementById('allTestResults');
      resultsDiv.innerHTML = '<div class="result-box info">æ­£åœ¨è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼Œè¯·ç¨å€™...</div>';

      // è¿è¡Œæ‰€æœ‰æµ‹è¯•
      const tests = [
        testBasicError,
        testErrorLocation,
        testStackTrace,
        testPromiseError,
        testMobileWebView,
        testMobileErrorHandling,
        testUserMessages,
        generateErrorReport
      ];

      let completed = 0;
      let passed = 0;
      let failed = 0;

      const runNextTest = (index) => {
        if (index >= tests.length) {
          // æ‰€æœ‰æµ‹è¯•å®Œæˆ
          button.disabled = false;
          button.textContent = 'è¿è¡Œæ‰€æœ‰æµ‹è¯•';
          showResult('allTestResults', `æµ‹è¯•å®Œæˆ: ${passed} é€šè¿‡, ${failed} å¤±è´¥, ${completed} æ€»è®¡`, passed === tests.length ? 'success' : 'error');
          return;
        }

        try {
          tests[index]();
          passed++;
          completed++;
          setTimeout(() => runNextTest(index + 1), 200);
        } catch (error) {
          failed++;
          completed++;
          console.error(`æµ‹è¯• ${index + 1} å¤±è´¥:`, error);
          setTimeout(() => runNextTest(index + 1), 200);
        }
      };

      runNextTest(0);
    };

    function showResult(containerId, message, type) {
      const container = document.getElementById(containerId);
      const resultBox = document.createElement('div');
      resultBox.className = `result-box ${type}`;
      resultBox.textContent = typeof message === 'string' ? message : JSON.stringify(message, null, 2);
      container.appendChild(resultBox);
    }

    // é¡µé¢åŠ è½½å®Œæˆæç¤º
    console.log('ğŸ‰ é”™è¯¯å¤„ç†éªŒè¯æµ‹è¯•é¡µé¢å·²åŠ è½½');
  </script>
</body>
</html>
